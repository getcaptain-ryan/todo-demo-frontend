name: Deploy to Railway Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to deploy (e.g., v1.0.0)'
        required: true
        type: string
      environment:
        description: 'Railway environment to deploy to'
        required: true
        type: choice
        options:
          - production
          - staging
        default: 'production'

env:
  SERVICE_NAME: todo-demo-frontend

jobs:
  validate:
    name: Validate Version Tag
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate tag exists
        run: |
          echo "Checking if tag '${{ inputs.version }}' exists..."

          if ! git rev-parse "${{ inputs.version }}" >/dev/null 2>&1; then
            echo "âŒ Tag '${{ inputs.version }}' does not exist in the repository"
            echo ""
            echo "Available tags:"
            git tag -l | tail -20
            echo ""
            echo "Please create the tag first or use an existing tag."
            exit 1
          fi

          echo "âœ… Tag '${{ inputs.version }}' exists"

      - name: Validate semantic versioning format
        run: |
          if [[ ! "${{ inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "âš ï¸  Warning: Version format '${{ inputs.version }}' does not follow semantic versioning"
            echo "Recommended format: v1.0.0, v1.2.3-beta, etc."
            echo "Continuing anyway..."
          else
            echo "âœ… Version format is valid: ${{ inputs.version }}"
          fi

  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    needs: validate
    container: ghcr.io/railwayapp/cli:latest
    # environment: ${{ inputs.environment }}  # Commented out to use repository secrets
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.version }}

      - name: Deploy to Railway
        run: |
          echo "ğŸš€ Deploying ${{ env.SERVICE_NAME }} version ${{ inputs.version }} to ${{ inputs.environment }}..."
          railway up \
            --service=${{ secrets.RAILWAY_SERVICE_ID }} \
            --detach
          echo "âœ… Deployment initiated successfully"

      - name: Wait for deployment to stabilize
        run: |
          echo "â³ Waiting 45 seconds for deployment to stabilize..."
          sleep 45

  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    container: ghcr.io/railwayapp/cli:latest
    # environment: ${{ inputs.environment }}  # Commented out to use repository secrets
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    steps:
      - name: Get service URL
        id: get-url
        run: |
          echo "Fetching service URL from Railway..."
          SERVICE_URL=$(railway domain --service=${{ secrets.RAILWAY_SERVICE_ID }} 2>/dev/null || echo "")

          if [ -z "$SERVICE_URL" ]; then
            echo "âš ï¸  No public domain found for service"
            echo "Skipping health check - service may not have a public URL"
            echo "url=" >> $GITHUB_OUTPUT
          else
            echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT
            echo "âœ… Service URL: https://$SERVICE_URL"
          fi

      - name: Health check
        if: steps.get-url.outputs.url != ''
        run: |
          SERVICE_URL="${{ steps.get-url.outputs.url }}"
          echo "ğŸ¥ Running health check on https://$SERVICE_URL/health"

          MAX_RETRIES=10
          RETRY_DELAY=10

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."

            if curl -f -s -m 10 "https://$SERVICE_URL/health" | grep -q 'ok'; then
              echo "âœ… Health check passed! Service is responding correctly."
              exit 0
            fi

            if [ $i -lt $MAX_RETRIES ]; then
              echo "â³ Health check failed, retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
            fi
          done

          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          echo "Service may still be starting up or experiencing issues"
          exit 1

      - name: Check deployment logs
        if: failure()
        run: |
          echo "ğŸ“‹ Fetching recent deployment logs..."
          railway logs --service=${{ secrets.RAILWAY_SERVICE_ID }} || true


  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy, verify]
    if: always() && (needs.deploy.result == 'failure' || needs.verify.result == 'failure')
    container: ghcr.io/railwayapp/cli:latest
    # environment: ${{ inputs.environment }}  # Commented out to use repository secrets
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    steps:
      - name: Rollback deployment
        run: |
          echo "âš ï¸  Deployment verification failed, initiating rollback..."
          railway rollback --service=${{ secrets.RAILWAY_SERVICE_ID }} || {
            echo "âŒ Rollback failed - manual intervention may be required"
            exit 1
          }
          echo "âœ… Rollback completed successfully"

      - name: Notify rollback
        run: |
          echo "ğŸ”” Deployment of version ${{ inputs.version }} was rolled back"

  tag-release:
    name: Tag Release
    runs-on: ubuntu-latest
    needs: verify
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.version }}
          fetch-depth: 0

      - name: Verify git tag exists
        run: |
          if git rev-parse "${{ inputs.version }}" >/dev/null 2>&1; then
            echo "âœ… Tag ${{ inputs.version }} exists and will be used for the release"
          else
            echo "âŒ Tag ${{ inputs.version }} does not exist. This workflow expects an existing tag."
            exit 1
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version }}
          name: Release ${{ inputs.version }}
          body: |
            ## ğŸš€ Deployment Summary

            **Version:** `${{ inputs.version }}`
            **Environment:** `${{ inputs.environment }}`
            **Service:** `${{ env.SERVICE_NAME }}`
            **Triggered by:** @${{ github.actor }}

            ### âœ… Deployment Status
            - Validation: Passed
            - Railway Deployment: Success
            - Health Check: See verify job logs (may be skipped if no public domain is configured)
            - Release Tagged: Yes

            ### ğŸ“¦ Components Deployed
            - React/Vite frontend with optimized production build
            - Health check endpoint: `/health`
            - Nginx web server on Alpine Linux
            - Multi-stage Docker build for minimal image size

            ### ğŸ”§ Configuration
            Environment variables are managed through Railway's dashboard:
            - `VITE_API_BASE_URL`: Backend API URL (set at build time)
            - `PORT`: Service port (auto-set by Railway, default 8080)
            - `NODE_ENV`: Environment mode (production)

            ### ğŸŒ Frontend Features
            - Responsive UI with Tailwind CSS
            - React Router for navigation
            - API integration with backend
            - Health monitoring endpoint
          draft: false
          prerelease: ${{ contains(inputs.version, '-') }}


